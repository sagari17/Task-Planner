<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My document</title>
    <link rel="stylesheet" type="text/css" href="css/style.css" />
    <script type="text/javascript" src="js/index.js"></script>
  </head>

  <body>
    <my-menu></my-menu>
    <div id="container"></div>
    

    <template id="profile">
      <div class="wrapperprofile">
      <img src="images/profile.svg" id="profileimg" />
      <h2 id="name">Jonathan Doe</h2>
      <p id="email">jonathandoe@gmail.com</p>
      <div class="buttonrow">
      <button id="edit" class="button-green">Edit Profile</button>
      <button id="changepw" class="button-green">Change Password</button>
    </div>
    <div class="buttonrow2">
      <button id="logout" class="button-blue">Logout</button>
      <button id="delete_user" class="button-red">Delete user</button>
      </div>
    </div>
    </template>

    <template id="editProfile">
        <div class="wrapperprofile">
            <img src="images/profile.svg" id="profileimg" />
            <h1>Edit profile</h1>
          <div class="textwrap">
      <input type="text" id="firstname" placeholder="Firstname" class="text-field"/>
      <input type="text" id="lastname" placeholder="Lastname" class="text-field"/>
      <input type="text" id="email" placeholder="E-mail" class="text-field"/>
          </div>
      <button type="button" id="save" class="button-green">Save Changes</button>
      <button type="button" id="goback" class="button-blue">Go Back</button>
    </div>
    </template>

    <template id="changePw">
      <div class="wrapperprofile">
          <img src="images/profile.svg" id="profileimg" />
        <h1>Change password</h1>
        <div class="textwrap">
      <input type="password" id="newpw" placeholder="New Password" class="text-field"/>
      <input
        type="password"
        id="newpwrepeat"
        placeholder="Repeat New Password"
        class="text-field"
      />
    </div>
      <button type="button" id="change"class="button-green" >Change Password</button>
      <button type="button" id="goback" class="button-blue">Go Back</button>
    </div>
    </template>
  </body>

  <script type="text/javascript" src="js/menuBar.js"></script>
  <script>
    let container = document.getElementById("container");
    let profileTmpl = document.getElementById("profile");
    let editTmpl = document.getElementById("editProfile");
    let changePwTmpl = document.getElementById("changePw");

    let userid = JSON.parse(sessionStorage.getItem("logindata")).userid;
    let userFirstname;
    let userLastname;
    let userEmail;

    showUserInfo();

    async function showUserInfo() {
      let url = "http://localhost:3000/users/" + userid;

      let cfg = {
        method: "GET",
        headers: { "Content-Type": "application/json" }
      };

      try {
        let data = await utilities.requestToServer(url, cfg);

        if (data == null) {
          throw data;
        } else {
          userFirstname = data[0].firstname;
          userLastname = data[0].lastname;
          userEmail = data[0].email;
          profileTmpl.content.querySelector("#name").innerHTML =
            userFirstname + " " + userLastname;
          profileTmpl.content.querySelector("#email").innerHTML = userEmail;

          container.innerHTML = "";
          container.appendChild(profileTmpl.content.cloneNode(true));

          document
            .querySelector("#edit")
            .addEventListener("click", editProfilePage);
          document
            .querySelector("#changepw")
            .addEventListener("click", changePasswordPage);
          document
            .querySelector("#logout")
            .addEventListener("click", logoutUser);
        }
      } catch (err) {
        console.log(err);
      }
    }

    function editProfilePage(evt) {
      container.innerHTML = "";
      container.appendChild(editTmpl.content.cloneNode(true));

      let firstname = document.querySelector("#firstname");
      firstname.value = userFirstname;
      let lastname = document.querySelector("#lastname");
      lastname.value = userLastname;
      let email = document.querySelector("#email");
      email.value = userEmail;

      document
        .querySelector("#goback")
        .addEventListener("click", function(evt) {
          showUserInfo();
        });

      document.querySelector("#save").addEventListener("click", function(evt) {
        saveChanges(firstname.value, lastname.value, email.value);
      });
    }

    function changePasswordPage(evt) {
      container.innerHTML = "";
      container.appendChild(changePwTmpl.content.cloneNode(true));

      let newpw = document.querySelector("#newpw");

      document
        .querySelector("#goback")
        .addEventListener("click", function(evt) {
          showUserInfo();
        });

      document
        .querySelector("#change")
        .addEventListener("click", function(evt) {
          changePw(newpw.value);
        });
    }

    async function saveChanges(firstname, lastname, email) {
      let url = "http://localhost:3000/users";

      let userData = {
        firstname: firstname,
        lastname: lastname,
        email: email,
        id: userid
      };
      console.log(userData);

      let cfg = {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(userData)
      };

      try {
        let data = await utilities.requestToServer(url, cfg);

        let sessionData = JSON.parse(sessionStorage.getItem("logindata"));
        sessionData.email = email;
        sessionStorage.setItem("logindata", JSON.stringify(sessionData));
        showUserInfo();
      } catch (err) {
        console.log(err);
      }
    }

    async function changePw(password) {
      let url = "http://localhost:3000/users/changePassword";

      let userData = {
        password: password,
        id: userid
      };
      console.log(userData);

      let cfg = {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(userData)
      };

      try {
        let data = await utilities.requestToServer(url, cfg);
        showUserInfo();
      } catch (err) {
        console.log(err);
      }
    }

    function logoutUser() {
      sessionStorage.removeItem("logindata");
      redirectNotAuthUser("index.html");
    }
  </script>
</html>
